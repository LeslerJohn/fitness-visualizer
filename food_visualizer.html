<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Database Visualizer - Diet Recommendations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #2ecc71 0%, #3498db 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }

        .filter-group select, .filter-group input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group select:focus, .filter-group input:focus {
            border-color: #2ecc71;
            outline: none;
        }

        .search-box {
            grid-column: 1 / -1;
            margin-top: 10px;
        }

        .stats-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }

        .foods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .food-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid #2ecc71;
        }

        .food-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        .food-name {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .food-category {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 15px;
        }

        .macros-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .macro-box {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .macro-label {
            font-size: 10px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .macro-value {
            font-size: 14px;
            font-weight: bold;
            color: #2c3e50;
        }

        .calories-display {
            text-align: center;
            background: #e8f5e8;
            padding: 8px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .calories-label {
            font-size: 10px;
            color: #27ae60;
            text-transform: uppercase;
            font-weight: bold;
        }

        .calories-value {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }

        .scores-section {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .scores-title {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            text-align: center;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }

        .score-item {
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            font-size: 11px;
        }

        .goal-score {
            background: #e3f2fd;
            color: #1976d2;
        }

        .somatotype-score {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .quality-info {
            margin-top: 15px;
            padding: 8px;
            background: #fff3e0;
            border-radius: 6px;
            border-left: 3px solid #ff9800;
        }

        .quality-label {
            font-size: 10px;
            color: #ef6c00;
            font-weight: bold;
            text-transform: uppercase;
        }

        .quality-value {
            font-size: 12px;
            color: #e65100;
            font-weight: bold;
        }

        .meal-timing {
            margin-top: 10px;
            font-size: 11px;
            color: #666;
            font-style: italic;
            text-align: center;
        }

        .loading, .no-results {
            text-align: center;
            padding: 60px 20px;
            color: white;
            font-size: 18px;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .recommendation-badge {
            background: #27ae60;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
            margin: 2px;
            display: inline-block;
        }

        .fiber-sugar-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        .fiber-box, .sugar-box {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
        }

        .fiber-box {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .sugar-box {
            background: #fff3e0;
            color: #f57c00;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .foods-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü•ó Food Database Visualizer</h1>
            <p>Comprehensive Diet Recommendations Database</p>
            <p><strong>‚úÖ Live Data Loading ‚Ä¢ üìä 5000+ Foods ‚Ä¢ üéØ Macro & Score Analysis</strong></p>
        </div>

        <div class="controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="category-filter">üçé Food Category:</label>
                    <select id="category-filter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="somatotype-filter">üß¨ Best for Somatotype:</label>
                    <select id="somatotype-filter">
                        <option value="">All Somatotypes</option>
                        <option value="ectomorph">Ectomorph</option>
                        <option value="mesomorph">Mesomorph</option>
                        <option value="endomorph">Endomorph</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="goal-filter">üéØ Best for Goal:</label>
                    <select id="goal-filter">
                        <option value="">All Goals</option>
                        <option value="weight_loss">Weight Loss</option>
                        <option value="weight_gain">Weight Gain</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="calories-min">üî• Min Calories (per 100g):</label>
                    <input type="number" id="calories-min" placeholder="0" min="0">
                </div>
                <div class="filter-group">
                    <label for="calories-max">üî• Max Calories (per 100g):</label>
                    <input type="number" id="calories-max" placeholder="1000" min="0">
                </div>
                <div class="filter-group">
                    <label for="protein-min">üí™ Min Protein (g per 100g):</label>
                    <input type="number" id="protein-min" placeholder="0" min="0" step="0.1">
                </div>
            </div>
            <div class="search-box">
                <div class="filter-group">
                    <label for="food-search">üîç Search Foods:</label>
                    <input type="text" id="food-search" placeholder="Search by food name..." style="width: 100%;">
                </div>
            </div>
        </div>

        <div class="stats-bar" id="stats-bar">
            Loading food database...
        </div>

        <div class="foods-grid" id="foods-container">
            <div class="loading">üîÑ Loading food database...</div>
        </div>
    </div>

    <script>
        // Global variables to store loaded data
        let allFoods = [];
        let filteredFoods = [];
        let allTemplates = [];

        // Load data from actual files
        async function loadData() {
            try {
                console.log('üîÑ Loading food database and templates...');
                
                // Load food database
                const foodResponse = await fetch('./data/datasets/diet/fndds_processed/optimized_diet_recommendation_database.csv');
                if (!foodResponse.ok) {
                    throw new Error(`Failed to load food database: ${foodResponse.status} ${foodResponse.statusText}`);
                }
                const foodCsvText = await foodResponse.text();
                console.log('‚úÖ Food database loaded successfully');
                
                // Load templates for recommendations
                const templateResponse = await fetch('./fixed_comprehensive_diet_templates_with_proper_exercise_ids.csv');
                if (!templateResponse.ok) {
                    throw new Error(`Failed to load templates: ${templateResponse.status} ${templateResponse.statusText}`);
                }
                const templateCsvText = await templateResponse.text();
                console.log('‚úÖ Templates loaded successfully');
                
                // Parse data
                allFoods = parseCSVData(foodCsvText);
                allTemplates = parseCSVData(templateCsvText);
                filteredFoods = [...allFoods];
                console.log('‚úÖ Parsed:', allFoods.length, 'foods and', allTemplates.length, 'templates');
                
                // Setup UI
                populateFilterOptions();
                renderFoods();
                updateStats();
                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                document.getElementById('foods-container').innerHTML = `
                    <div class="error">
                        ‚ùå Error loading data: ${error.message}
                        <br><br>Please ensure all files are in the correct location:
                        <br>‚Ä¢ data/datasets/diet/fndds_processed/optimized_diet_recommendation_database.csv
                        <br>‚Ä¢ fixed_comprehensive_diet_templates_with_proper_exercise_ids.csv
                    </div>
                `;
            }
        }

        // Utility Functions
        function parseCSVData(csvString) {
            const lines = csvString.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"' && (j === 0 || lines[i][j-1] === ',')) {
                        insideQuotes = true;
                    } else if (char === '"' && (j === lines[i].length - 1 || lines[i][j+1] === ',')) {
                        insideQuotes = false;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim().replace(/"/g, ''));
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim().replace(/"/g, ''));
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            return data;
        }

        function populateFilterOptions() {
            const categoryFilter = document.getElementById('category-filter');
            const categories = [...new Set(allFoods.map(food => food.Enhanced_Category))].filter(cat => cat).sort();
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = formatText(category);
                categoryFilter.appendChild(option);
            });
        }

        function formatText(text) {
            return text.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getBestSomatotype(food) {
            const scores = [
                { type: 'ectomorph', score: parseFloat(food.Ectomorph_Score) || 0 },
                { type: 'mesomorph', score: parseFloat(food.Mesomorph_Score) || 0 },
                { type: 'endomorph', score: parseFloat(food.Endomorph_Score) || 0 }
            ];
            return scores.reduce((max, current) => current.score > max.score ? current : max);
        }

        function getBestGoal(food) {
            const scores = [
                { type: 'weight_loss', score: parseFloat(food.Weight_Loss_Score) || 0 },
                { type: 'weight_gain', score: parseFloat(food.Weight_Gain_Score) || 0 },
                { type: 'maintenance', score: parseFloat(food.Maintenance_Score) || 0 }
            ];
            return scores.reduce((max, current) => current.score > max.score ? current : max);
        }

        function isRecommendedInTemplates(foodName) {
            return allTemplates.some(template => {
                const allMeals = [
                    template.breakfast_foods,
                    template.lunch_foods,
                    template.dinner_foods,
                    template.snack_foods
                ].join(' | ').toLowerCase();
                return allMeals.includes(foodName.toLowerCase());
            });
        }

        function createFoodCard(food) {
            const calories = parseFloat(food.Calories_kcal) || 0;
            const protein = parseFloat(food.Protein_g) || 0;
            const carbs = parseFloat(food.Carbohydrates_g) || 0;
            const fat = parseFloat(food.Fat_g) || 0;
            const fiber = parseFloat(food.Fiber_g) || 0;
            const sugars = parseFloat(food.Sugars_g) || 0;
            
            const bestSomatotype = getBestSomatotype(food);
            const bestGoal = getBestGoal(food);
            const isRecommended = isRecommendedInTemplates(food.Food_Item);
            
            const qualityScore = parseFloat(food.Overall_Quality) || 0;
            const nutrientDensity = parseFloat(food.Nutrient_Density_Score) || 0;

            return `
                <div class="food-card">
                    <div class="food-name">${food.Food_Item}${isRecommended ? ' ‚≠ê' : ''}</div>
                    <div class="food-category">${formatText(food.Enhanced_Category || 'Other')}</div>
                    
                    <div class="calories-display">
                        <div class="calories-label">Calories (per 100g)</div>
                        <div class="calories-value">${calories.toFixed(0)}</div>
                    </div>

                    <div class="macros-grid">
                        <div class="macro-box">
                            <div class="macro-label">Protein</div>
                            <div class="macro-value">${protein.toFixed(1)}g</div>
                        </div>
                        <div class="macro-box">
                            <div class="macro-label">Carbs</div>
                            <div class="macro-value">${carbs.toFixed(1)}g</div>
                        </div>
                        <div class="macro-box">
                            <div class="macro-label">Fat</div>
                            <div class="macro-value">${fat.toFixed(1)}g</div>
                        </div>
                    </div>

                    <div class="fiber-sugar-info">
                        <div class="fiber-box">
                            <strong>Fiber:</strong> ${fiber.toFixed(1)}g
                        </div>
                        <div class="sugar-box">
                            <strong>Sugar:</strong> ${sugars.toFixed(1)}g
                        </div>
                    </div>

                    <div class="scores-section">
                        <div class="scores-title">üéØ Goal Suitability Scores</div>
                        <div class="scores-grid">
                            <div class="score-item goal-score">
                                <strong>Loss:</strong> ${food.Weight_Loss_Score}/10
                            </div>
                            <div class="score-item goal-score">
                                <strong>Gain:</strong> ${food.Weight_Gain_Score}/10
                            </div>
                            <div class="score-item goal-score">
                                <strong>Maintain:</strong> ${food.Maintenance_Score}/10
                            </div>
                        </div>
                        
                        <div class="scores-title" style="margin-top: 10px;">üß¨ Somatotype Scores</div>
                        <div class="scores-grid">
                            <div class="score-item somatotype-score">
                                <strong>Ecto:</strong> ${food.Ectomorph_Score}/10
                            </div>
                            <div class="score-item somatotype-score">
                                <strong>Meso:</strong> ${food.Mesomorph_Score}/10
                            </div>
                            <div class="score-item somatotype-score">
                                <strong>Endo:</strong> ${food.Endomorph_Score}/10
                            </div>
                        </div>
                    </div>

                    <div class="quality-info">
                        <div class="quality-label">Overall Quality Score</div>
                        <div class="quality-value">${qualityScore.toFixed(1)}/20 | Nutrient Density: ${nutrientDensity.toFixed(1)}/10</div>
                    </div>

                    ${food.Meal_Timing ? `
                        <div class="meal-timing">
                            üçΩÔ∏è Best timing: ${food.Meal_Timing.replace(/_/g, ' ')}
                        </div>
                    ` : ''}

                    ${isRecommended ? `
                        <div style="text-align: center; margin-top: 10px;">
                            <span class="recommendation-badge">Featured in Templates</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function applyFilters() {
            const filters = {
                category: document.getElementById('category-filter').value,
                somatotype: document.getElementById('somatotype-filter').value,
                goal: document.getElementById('goal-filter').value,
                caloriesMin: parseFloat(document.getElementById('calories-min').value) || 0,
                caloriesMax: parseFloat(document.getElementById('calories-max').value) || Infinity,
                proteinMin: parseFloat(document.getElementById('protein-min').value) || 0,
                search: document.getElementById('food-search').value.toLowerCase()
            };

            filteredFoods = allFoods.filter(food => {
                const calories = parseFloat(food.Calories_kcal) || 0;
                const protein = parseFloat(food.Protein_g) || 0;
                
                // Category filter
                if (filters.category && food.Enhanced_Category !== filters.category) return false;
                
                // Numeric filters
                if (calories < filters.caloriesMin || calories > filters.caloriesMax) return false;
                if (protein < filters.proteinMin) return false;
                
                // Search filter
                if (filters.search && !food.Food_Item.toLowerCase().includes(filters.search)) return false;
                
                // Somatotype filter (find foods best suited for this somatotype)
                if (filters.somatotype) {
                    const bestSomatotype = getBestSomatotype(food);
                    if (bestSomatotype.type !== filters.somatotype) return false;
                }
                
                // Goal filter (find foods best suited for this goal)
                if (filters.goal) {
                    const bestGoal = getBestGoal(food);
                    if (bestGoal.type !== filters.goal) return false;
                }
                
                return true;
            });

            renderFoods();
            updateStats();
        }

        function renderFoods() {
            const container = document.getElementById('foods-container');
            
            if (filteredFoods.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        üîç No foods found matching your filters.<br>
                        Try adjusting your filter criteria.
                    </div>
                `;
                return;
            }

            // Sort by overall quality score (descending)
            const sortedFoods = [...filteredFoods].sort((a, b) => 
                (parseFloat(b.Overall_Quality) || 0) - (parseFloat(a.Overall_Quality) || 0)
            );

            container.innerHTML = sortedFoods.map(createFoodCard).join('');
        }

        function updateStats() {
            const stats = document.getElementById('stats-bar');
            const avgCalories = filteredFoods.length > 0 ? 
                (filteredFoods.reduce((sum, food) => sum + (parseFloat(food.Calories_kcal) || 0), 0) / filteredFoods.length).toFixed(0) : 0;
            stats.textContent = `üìä Showing ${filteredFoods.length} of ${allFoods.length} foods | Avg Calories: ${avgCalories}`;
        }

        function setupEventListeners() {
            const filterIds = ['category-filter', 'somatotype-filter', 'goal-filter', 'calories-min', 'calories-max', 'protein-min'];
            filterIds.forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            
            document.getElementById('food-search').addEventListener('input', applyFilters);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
